<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enviar Remesa - Happy Remesitas</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#10B981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Remesitas">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192.png') }}">
    <meta name="description" content="Envio de remesas rapido y seguro a Cuba">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --primary: #10B981; --primary-dark: #059669; --accent: #F59E0B; --dark: #1F2937; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: linear-gradient(135deg, #10B981 0%, #047857 100%); min-height: 100vh; }
        .app-container { max-width: 500px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        .app-header { text-align: center; color: white; padding: 30px 0 20px; }
        .app-header img { width: 80px; height: 80px; border-radius: 20px; background: white; padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .app-header h1 { font-size: 1.8rem; font-weight: 800; margin-top: 15px; }
        .app-header p { opacity: 0.9; font-size: 0.95rem; }
        .card { border: none; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); margin-bottom: 16px; overflow: hidden; }
        .card-header { background: white; font-weight: 700; padding: 16px 20px; color: var(--dark); border-bottom: 1px solid #f0f0f0; }
        .card-body { padding: 20px; background: white; }
        .form-control { border-radius: 12px; padding: 14px 16px; border: 2px solid #e5e7eb; font-size: 16px; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15); }
        .input-group-text { background: #f9fafb; border: 2px solid #e5e7eb; border-right: none; color: #6b7280; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border: none; border-radius: 14px; padding: 16px; font-size: 1.1rem; font-weight: 700; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); }
        .resultado-box { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-radius: 20px; padding: 24px; text-align: center; }
        .resultado-box h3 { font-size: 2.8rem; font-weight: 800; margin: 8px 0; }
        .tipo-selector { display: flex; gap: 12px; margin-bottom: 16px; }
        .tipo-btn { flex: 1; padding: 16px; border: 2px solid #e5e7eb; border-radius: 14px; background: white; cursor: pointer; text-align: center; transition: all 0.2s; }
        .tipo-btn:hover { border-color: var(--primary); }
        .tipo-btn.active { border-color: var(--primary); background: rgba(16, 185, 129, 0.08); }
        .tipo-btn i { font-size: 28px; display: block; margin-bottom: 8px; }
        .info-box { border-radius: 14px; padding: 16px; }
        .info-zelle { background: #eff6ff; border-left: 4px solid #3b82f6; }
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-around; }
        .nav-bottom a { text-decoration: none; color: #9ca3af; text-align: center; font-size: 12px; font-weight: 600; }
        .nav-bottom a.active { color: var(--primary); }
        .nav-bottom i { font-size: 24px; display: block; margin-bottom: 4px; }
        .form-label { font-weight: 600; color: var(--dark); margin-bottom: 8px; font-size: 0.9rem; }
        @keyframes pulse { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Happy Remesitas">
            <h1>Happy Remesitas</h1>
            <p>Envio rapido y seguro a Cuba</p>
        </div>
        <form method="POST" id="formSolicitud">
            <div class="card">
                <div class="card-header"><i class="bi bi-cash-stack me-2"></i>Tipo de Entrega</div>
                <div class="card-body">
                    <div class="tipo-selector">
                        <div class="tipo-btn active" data-tipo="MN" onclick="seleccionarTipo('MN')">
                            <i class="bi bi-currency-exchange" style="color: var(--primary);"></i>
                            <strong>Moneda Nacional</strong>
                            <small class="d-block text-muted">CUP</small>
                        </div>
                        <div class="tipo-btn" data-tipo="USD" onclick="seleccionarTipo('USD')">
                            <i class="bi bi-currency-dollar" style="color: var(--accent);"></i>
                            <strong>Dolares</strong>
                            <small class="d-block text-muted">USD</small>
                        </div>
                    </div>
                    <input type="hidden" name="tipo_entrega" id="tipo_entrega" value="MN">
                    <label class="form-label">Monto a enviar (USD)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" name="monto_envio" id="monto_envio" class="form-control form-control-lg" placeholder="0.00" step="0.01" min="1" required value="{{ remesa_anterior.monto_envio if remesa_anterior else '' }}" oninput="calcularEntrega()" onchange="calcularEntrega()">
                        <span class="input-group-text">USD</span>
                    </div>
                </div>
            </div>
            <div class="resultado-box mb-3">
                <small>Beneficiario recibe aproximadamente</small>
                <h3 id="montoEntrega">0.00</h3>
                <span id="monedaEntrega">CUP</span>
            </div>
            <div class="card">
                <div class="card-header"><i class="bi bi-person me-2"></i>Tus Datos</div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" name="remitente_nombre" id="remitente_nombre" class="form-control" placeholder="Tu nombre completo" required value="{{ remesa_anterior.remitente_nombre if remesa_anterior else '' }}">
                    </div>
                    <div>
                        <input type="tel" name="remitente_telefono" id="remitente_telefono" class="form-control" placeholder="Tu telefono (+1...)" onblur="buscarDatosCliente()" required value="{{ remesa_anterior.remitente_telefono if remesa_anterior else '' }}">
                    </div>
                </div>
            </div>
            <div id="historial-cliente" class="card mb-3" style="display: none;">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-clock-history me-2"></i>Tus remesas anteriores</span>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cerrarHistorial()"><i class="bi bi-x"></i></button>
                </div>
                <div class="card-body p-2" id="lista-historial" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div id="beneficiarios-anteriores" class="card" style="display: none;">
                <div class="card-header bg-success text-white"><i class="bi bi-people me-2"></i>Tus beneficiarios anteriores</div>
                <div class="card-body p-2" id="lista-beneficiarios"></div>
            </div>
            <div class="card">
                <div class="card-header"><i class="bi bi-person-check me-2"></i>Datos del Beneficiario</div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" name="beneficiario_nombre" id="beneficiario_nombre" class="form-control" placeholder="Nombre del beneficiario" required value="{{ remesa_anterior.beneficiario_nombre if remesa_anterior else '' }}">
                    </div>
                    <div class="mb-3">
                        <input type="tel" name="beneficiario_telefono" id="beneficiario_telefono" class="form-control" placeholder="Telefono del beneficiario" value="{{ remesa_anterior.beneficiario_telefono if remesa_anterior else '' }}">
                    </div>
                    <div>
                        <textarea name="beneficiario_direccion" id="beneficiario_direccion" class="form-control" rows="2" placeholder="Direccion de entrega en Cuba">{{ remesa_anterior.beneficiario_direccion if remesa_anterior else '' }}</textarea>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><i class="bi bi-credit-card me-2"></i>Pago por Zelle</div>
                <div class="card-body">
                    <div class="info-box info-zelle">
                        <h6 class="mb-2"><i class="bi bi-bank me-1"></i> Envia tu pago a:</h6>
                        <p class="mb-2 fw-bold" style="font-size: 1.1rem;">7865359229</p>
                        <hr>
                        <small class="text-muted"><i class="bi bi-exclamation-triangle text-warning me-1"></i><strong>IMPORTANTE:</strong> Sin comentarios en la transferencia. Si es obligatorio, poner solo <strong>"happy"</strong></small>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100 mb-3"><i class="bi bi-send-fill me-2"></i>Enviar Solicitud</button>
        </form>
    </div>
    <div class="nav-bottom">
        <a href="/solicitar" class="active"><i class="bi bi-plus-circle-fill"></i>Nueva</a>
        <a href="/mis-remesas"><i class="bi bi-clock-history"></i>Historial</a>
        <a href="/seguimiento"><i class="bi bi-search"></i>Rastrear</a>
    </div>
    <div id="install-banner" style="display: block; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 9999;">
        <button id="install-btn" onclick="instalarApp()" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1rem; font-weight: 700; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4); cursor: pointer; display: flex; align-items: center; gap: 10px; animation: pulse 2s infinite;">
            <i class="bi bi-download"></i> Instalar App
        </button>
    </div>
    <div id="ios-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px;">
                <div class="modal-body text-center p-4">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" style="width: 80px; margin-bottom: 15px;">
                    <h5 class="fw-bold">Instalar Happy Remesitas</h5>
                    <p class="text-muted">Para instalar la app en tu iPhone:</p>
                    <div class="text-start bg-light p-3 rounded-3">
                        <p class="mb-2"><strong>1.</strong> Toca el boton <i class="bi bi-box-arrow-up"></i> de compartir</p>
                        <p class="mb-2"><strong>2.</strong> Desplazate hacia abajo</p>
                        <p class="mb-0"><strong>3.</strong> Selecciona <strong>"Anadir a inicio"</strong></p>
                    </div>
                    <button class="btn btn-success btn-lg w-100 mt-3" data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const tasaActual = {{ tasa_actual }};
        const descuentoMN = {{ descuento_mn }};
        const comisionUSD = {{ comision_usd }} / 100;

        function seleccionarTipo(tipo) {
            document.querySelectorAll('.tipo-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-tipo="' + tipo + '"]').classList.add('active');
            document.getElementById('tipo_entrega').value = tipo;
            calcularEntrega();
        }

        function calcularEntrega() {
            const monto = parseFloat(document.getElementById('monto_envio').value) || 0;
            const tipo = document.getElementById('tipo_entrega').value;
            let entrega, moneda;
            if (tipo === 'USD') {
                entrega = monto * (1 - comisionUSD);
                moneda = 'USD';
            } else {
                entrega = monto * (tasaActual - descuentoMN);
                moneda = 'CUP';
            }
            document.getElementById('montoEntrega').textContent = entrega.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('monedaEntrega').textContent = moneda;
        }

        document.addEventListener('DOMContentLoaded', function() { calcularEntrega(); });

        function buscarDatosCliente() {
            const telefono = document.getElementById('remitente_telefono').value;
            if (telefono.length < 8) return;
            fetch('/api/cliente-datos', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({telefono: telefono}) })
            .then(r => r.json())
            .then(data => {
                if (data.encontrado) {
                    const nombreField = document.getElementById('remitente_nombre');
                    if (!nombreField.value) nombreField.value = data.remitente_nombre;
                    if (data.beneficiarios && data.beneficiarios.length > 0) {
                        const lista = document.getElementById('lista-beneficiarios');
                        lista.innerHTML = data.beneficiarios.map(b => '<div class="p-2 border-bottom" style="cursor:pointer;" onclick="seleccionarBeneficiario(this)" data-nombre="' + b.nombre + '" data-telefono="' + (b.telefono || '') + '" data-direccion="' + (b.direccion || '') + '"><strong>' + b.nombre + '</strong>' + (b.telefono ? '<br><small class="text-muted">' + b.telefono + '</small>' : '') + '</div>').join('');
                        document.getElementById('beneficiarios-anteriores').style.display = 'block';
                    }
                    cargarHistorial(telefono);
                }
            });
        }

        function cargarHistorial(telefono) {
            fetch('/api/historial-cliente', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({telefono: telefono}) })
            .then(r => r.json())
            .then(data => {
                if (data.remesas && data.remesas.length > 0) {
                    const lista = document.getElementById('lista-historial');
                    lista.innerHTML = data.remesas.map(r => '<div class="p-2 border-bottom d-flex justify-content-between align-items-center"><div><strong>' + r.beneficiario + '</strong><br><small class="text-muted">$' + r.monto + ' USD - ' + r.fecha + '</small><br><span class="badge bg-' + r.estado_color + '">' + r.estado + '</span></div><a href="/repetir/' + r.id + '" class="btn btn-sm btn-success"><i class="bi bi-arrow-repeat"></i></a></div>').join('');
                    document.getElementById('historial-cliente').style.display = 'block';
                }
            });
        }

        function seleccionarBeneficiario(el) {
            document.getElementById('beneficiario_nombre').value = el.dataset.nombre;
            document.getElementById('beneficiario_telefono').value = el.dataset.telefono;
            document.getElementById('beneficiario_direccion').value = el.dataset.direccion;
            document.getElementById('beneficiarios-anteriores').style.display = 'none';
        }

        function cerrarHistorial() { document.getElementById('historial-cliente').style.display = 'none'; }

        let deferredPrompt = null;
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        if (isStandalone) document.getElementById('install-banner').style.display = 'none';

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('install-banner').style.display = 'block'; });

        function instalarApp() {
            if (isIOS) { new bootstrap.Modal(document.getElementById('ios-modal')).show(); }
            else if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((result) => { if (result.outcome === 'accepted') document.getElementById('install-banner').style.display = 'none'; deferredPrompt = null; }); }
            else { alert('Para instalar: abre el menu del navegador y selecciona "Agregar a pantalla de inicio"'); }
        }

        window.addEventListener('appinstalled', () => { document.getElementById('install-banner').style.display = 'none'; });

        if ('serviceWorker' in navigator) { window.addEventListener('load', function() { navigator.serviceWorker.register('/sw.js', {scope: '/'}).catch(e => console.log('SW error', e)); }); }
    </script>
</body>
</html>