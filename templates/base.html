<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Happy Remesitas{% endblock %}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">

    <!-- PWA -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#10B981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Remesitas">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192.png') }}">
    <meta name="description" content="Envio de remesas rapido y seguro a Cuba">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if current_user.is_authenticated %}
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebarMenu">
                <div class="position-sticky pt-0">
                    <div class="sidebar-logo">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Happy Remesitas">
                        <h5>Happy Remesitas</h5>
                        <small><i class="bi bi-person-circle"></i> {{ current_user.nombre }}</small>
                    </div>
                    <ul class="nav flex-column mt-3">
                        {% if current_user.es_admin() %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'remesas.dashboard' %}active{% endif %}" href="{{ url_for('remesas.dashboard') }}">
                                <i class="bi bi-grid-1x2-fill"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if 'remesas' in request.endpoint and request.endpoint != 'remesas.dashboard' %}active{% endif %}" href="{{ url_for('remesas.lista') }}">
                                <i class="bi bi-send-fill"></i> Remesas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if 'solicitudes' in request.endpoint %}active{% endif %}" href="{{ url_for('admin.solicitudes') }}">
                                <i class="bi bi-inbox-fill"></i> Solicitudes
                            </a>
                        </li>
                        <li class="nav-item mt-2">
                            <a class="nav-link" data-bs-toggle="collapse" href="#reportesMenu">
                                <i class="bi bi-bar-chart-fill"></i> Reportes <i class="bi bi-chevron-down float-end small"></i>
                            </a>
                            <div class="collapse" id="reportesMenu">
                                <ul class="nav flex-column">
                                    <li class="nav-item"><a class="nav-link" href="{{ url_for('reportes.balance') }}"><i class="bi bi-wallet2"></i> Balance</a></li>
                                    <li class="nav-item"><a class="nav-link" href="{{ url_for('reportes.pagos') }}"><i class="bi bi-cash-coin"></i> Pagos</a></li>
                                    <li class="nav-item"><a class="nav-link" href="{{ url_for('reportes.por_repartidor') }}"><i class="bi bi-people-fill"></i> Repartidores</a></li>
                                </ul>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="collapse" href="#adminMenu">
                                <i class="bi bi-gear-fill"></i> Gestion <i class="bi bi-chevron-down float-end small"></i>
                            </a>
                            <div class="collapse" id="adminMenu">
                                <ul class="nav flex-column">
                                    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.usuarios') }}"><i class="bi bi-people-fill"></i> Usuarios</a></li>
                                    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.revendedores') }}"><i class="bi bi-shop"></i> Revendedores</a></li>
                                    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.efectivo') }}"><i class="bi bi-cash-stack"></i> Efectivo Repartidores</a></li>
                                    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.tasas') }}"><i class="bi bi-currency-exchange"></i> Tasas</a></li>
                                    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.comisiones') }}"><i class="bi bi-percent"></i> Comisiones</a></li>
                                </ul>
                            </div>
                        </li>
                        {% elif current_user.es_revendedor() %}
                        <li class="nav-item"><a class="nav-link {% if request.endpoint == 'revendedor.panel' %}active{% endif %}" href="{{ url_for('revendedor.panel') }}"><i class="bi bi-grid-1x2-fill"></i> Mi Panel</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('revendedor.nueva_remesa') }}"><i class="bi bi-plus-circle-fill"></i> Nueva Remesa</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('revendedor.mis_remesas') }}"><i class="bi bi-list-ul"></i> Mis Remesas</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('revendedor.balance') }}"><i class="bi bi-wallet2"></i> Mi Balance</a></li>
                        {% else %}
                        <li class="nav-item"><a class="nav-link {% if request.endpoint == 'remesas.mis_entregas' %}active{% endif %}" href="{{ url_for('remesas.mis_entregas') }}"><i class="bi bi-truck"></i> Mis Entregas</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('remesas.historial') }}"><i class="bi bi-clock-history"></i> Historial</a></li>
                        {% endif %}
                        <li class="nav-item mt-4 pt-3" style="border-top: 1px solid #e5e7eb;">
                            <a class="nav-link" href="{{ url_for('auth.cambiar_password') }}"><i class="bi bi-key-fill"></i> Cambiar Clave</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-danger" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right"></i> Cerrar Sesion</a>
                        </li>
                    </ul>
                </div>
            </nav>
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 content-wrapper">
                <nav class="navbar d-md-none mb-3 mobile-navbar">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="{{ url_for('index') }}">
                            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo">
                            <span>Happy Remesitas</span>
                        </a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
                            <i class="bi bi-list" style="color: white; font-size: 1.5rem;"></i>
                        </button>
                    </div>
                </nav>
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ 'warning' if category == 'whatsapp' else ('danger' if category == 'error' else category) }} alert-dismissible fade show mt-3">
                        <i class="bi bi-{% if category == 'error' or category == 'danger' %}exclamation-triangle{% elif category == 'success' %}check-circle{% elif category == 'whatsapp' %}whatsapp{% else %}info-circle{% endif %}-fill me-2"></i>
                        {% if category == 'whatsapp' %}{{ message|safe }}{% else %}{{ message }}{% endif %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                {% endif %}
                {% endwith %}
                <div class="py-4">{% block content %}{% endblock %}</div>
            </main>
        </div>
    </div>
    {% else %}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="container mt-3">
        {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    {% block content_public %}{% endblock %}
    {% endif %}

    <!-- PWA Install Banner -->
    <div id="install-banner" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
        <button id="install-btn" onclick="instalarApp()" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1rem; font-weight: 700; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4); cursor: pointer; display: flex; align-items: center; gap: 10px; animation: pulse 2s infinite;">
            <i class="bi bi-download"></i> Instalar App
        </button>
    </div>

    <!-- iOS Install Modal -->
    <div id="ios-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px;">
                <div class="modal-body text-center p-4">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" style="width: 80px; margin-bottom: 15px;">
                    <h5 class="fw-bold">Instalar Happy Remesitas</h5>
                    <p class="text-muted">Para instalar la app en tu iPhone:</p>
                    <div class="text-start bg-light p-3 rounded-3">
                        <p class="mb-2"><strong>1.</strong> Toca el boton <i class="bi bi-box-arrow-up"></i> de compartir</p>
                        <p class="mb-2"><strong>2.</strong> Desplazate hacia abajo</p>
                        <p class="mb-0"><strong>3.</strong> Selecciona <strong>"Anadir a inicio"</strong></p>
                    </div>
                    <button class="btn btn-success btn-lg w-100 mt-3" data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js', {scope: '/'})
                .then(function(registration) {
                    console.log('SW registrado:', registration.scope);
                })
                .catch(function(error) {
                    console.log('SW error:', error);
                });
        });
    }
    </script>

    <!-- PWA Install Script -->
    <script>
    let deferredPrompt = null;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    // Ocultar si ya esta instalada
    if (isStandalone) {
        document.getElementById('install-banner').style.display = 'none';
    }

    // Capturar evento de instalacion (Android/Chrome)
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('install-banner').style.display = 'block';
    });

    // Funcion para instalar
    function instalarApp() {
        if (isIOS) {
            new bootstrap.Modal(document.getElementById('ios-modal')).show();
        } else if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((result) => {
                if (result.outcome === 'accepted') {
                    document.getElementById('install-banner').style.display = 'none';
                }
                deferredPrompt = null;
            });
        } else {
            alert('Para instalar: abre el menu del navegador y selecciona "Agregar a pantalla de inicio"');
        }
    }

    // Ocultar despues de instalar
    window.addEventListener('appinstalled', () => {
        document.getElementById('install-banner').style.display = 'none';
    });

    // Mostrar boton en iOS si no esta instalada
    if (isIOS && !isStandalone) {
        document.getElementById('install-banner').style.display = 'block';
    }
    </script>

    <!-- Push Notifications -->
    <script>
    // Inicializar Push Notifications
    async function initPushNotifications() {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            console.log('Push notifications no soportadas');
            return;
        }

        // Verificar permiso actual
        if (Notification.permission === 'denied') {
            console.log('Notificaciones bloqueadas por el usuario');
            return;
        }

        try {
            // Obtener VAPID key del servidor
            const response = await fetch('/api/push/vapid-key');
            const data = await response.json();

            if (!data.publicKey) {
                console.log('VAPID no configurado en servidor');
                return;
            }

            // Esperar a que el SW este listo
            const registration = await navigator.serviceWorker.ready;

            // Verificar si ya esta suscrito
            let subscription = await registration.pushManager.getSubscription();

            if (!subscription) {
                // Solicitar permiso si no lo tiene
                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        console.log('Permiso de notificaciones denegado');
                        return;
                    }
                }

                // Crear nueva suscripcion
                subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(data.publicKey)
                });
            }

            // Enviar suscripcion al servidor
            await fetch('/api/push/suscribir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(subscription.toJSON())
            });

            console.log('Suscripcion push activa');

        } catch (error) {
            console.error('Error configurando push:', error);
        }
    }

    // Convertir VAPID key de base64 a Uint8Array
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    // Inicializar cuando la pagina cargue
    {% if current_user.is_authenticated %}
    window.addEventListener('load', () => {
        // Esperar un poco para no bloquear la carga inicial
        setTimeout(initPushNotifications, 2000);
    });
    {% endif %}
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>